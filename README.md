# GCP Serverless Infra with Terragrunt

## Overview
This project provisions a complete Google Cloud Platform (GCP) serverless infrastructure using Terraform modules managed by Terragrunt. It is designed for environments like `dev`, `stage`, and `prod`, and automates resource tracking, logging, and event-driven workflows.

## Workflow & Purpose

### What does this infrastructure do?
- **Cloud Function**: A Python function is triggered by Pub/Sub messages. It collects information about GCP resources (buckets, topics, functions, etc.) and writes logs to a GCS bucket.
- **Pub/Sub**: A topic and subscription are created. The topic is used to trigger the Cloud Function and to receive scheduled messages.
- **Cloud Scheduler**: Schedules a daily job (7am UTC) to publish a message to the Pub/Sub topic, triggering the Cloud Function automatically.
- **Cloud Run**: Deploys a sample public Cloud Run service (can be extended for microservices or APIs).
- **Storage**: Creates a GCS bucket to store logs generated by the Cloud Function.
- **IAM**: Grants least-privilege permissions to the Cloud Function and Scheduler for secure operation.

### Why do we need this?
- **Automated Resource Tracking**: The Cloud Function logs the state of your GCP resources daily, providing an auditable history and helping with compliance, troubleshooting, and cost control.
- **Event-Driven Automation**: Pub/Sub and Scheduler enable serverless, event-driven workflows without manual intervention.
- **Separation of Environments**: Terragrunt allows you to manage multiple environments (dev, stage, prod) with minimal duplication and maximum safety.
- **Security**: IAM roles are tightly scoped to follow the principle of least privilege.
- **Scalability & Modularity**: Each component is a reusable module, making it easy to extend or adapt for new use cases.

## How is this useful?
- **Ops/DevOps**: Automated daily logging of resources helps with audits, troubleshooting, and understanding cloud usage.
- **Developers**: Easily add new serverless functions, APIs, or event-driven automations.
- **Security/Compliance**: Maintains a log of resource state and access, supporting compliance requirements.
- **Cost Management**: Track resource creation and deletion over time.

## Usage
1. **Clone the repo and set up your GCP credentials.**
2. **Build your function code and zip it as `function-source.zip`, placing it in `modules/cloud_function/`.**
3. **Configure your environment in `envs/dev/terragrunt.hcl` (or `stage`/`prod`).**
4. **Run Terragrunt commands:**
   ```sh
   cd envs/dev
   terragrunt init
   terragrunt plan
   terragrunt apply
   ```
5. **Check outputs and logs in your GCS bucket.**

## Project Structure
```
modules/
  cloud_function/
  cloud_run/
  iam/
  pubsub/
  scheduler/
  storage/
envs/
  dev/
  stage/
  prod/
```

## Extending
- Add more functions, triggers, or services by creating new modules or extending existing ones.
- Use different GCP projects or regions per environment by editing the relevant `terragrunt.hcl`.

## Requirements
- [Terraform](https://www.terraform.io/)
- [Terragrunt](https://terragrunt.gruntwork.io/)
- [gcloud CLI](https://cloud.google.com/sdk/docs/install)
- GCP service account with appropriate permissions

---
**This setup provides a production-grade, auditable, and modular GCP serverless foundation for any team or project.**
